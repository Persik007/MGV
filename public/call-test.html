<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MGV ‚Äî –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0f1a;
            color: #e2e8f0;
            padding: 20px;
            font-size: 13px;
        }
        
        h1 {
            color: #3b82f6;
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .sub {
            color: #4a5568;
            font-size: 11px;
            margin-bottom: 24px;
        }
        
        .section {
            background: #0d1117;
            border: 1px solid #1e2d45;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .section h2 {
            font-size: 12px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #4a5568;
            margin-bottom: 12px;
        }
        
        .btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn.red {
            background: #ef4444;
        }
        
        .btn.green {
            background: #10b981;
        }
        
        .btn:disabled {
            opacity: .4;
            cursor: default;
        }
        
        .log {
            background: #060a12;
            border: 1px solid #1e2d45;
            border-radius: 8px;
            padding: 12px;
            min-height: 80px;
            max-height: 280px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.7;
        }
        
        .log .ok {
            color: #10b981;
        }
        
        .log .err {
            color: #ef4444;
        }
        
        .log .warn {
            color: #f59e0b;
        }
        
        .log .info {
            color: #60a5fa;
        }
        
        .log .dim {
            color: #4a5568;
        }
        
        .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4a5568;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        .status.green {
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
        }
        
        .status.red {
            background: #ef4444;
        }
        
        .status.yellow {
            background: #f59e0b;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%,
            100% {
                opacity: 1
            }
            50% {
                opacity: .3
            }
        }
        
        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .label {
            color: #4a5568;
            width: 160px;
            flex-shrink: 0;
        }
        
        .val {
            color: #e2e8f0;
            font-weight: 600;
        }
        
        .pair-box {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .peer-col {
            flex: 1;
            min-width: 280px;
        }
        
        .peer-col h3 {
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #3b82f6;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e2d45;
        }
        
        video {
            width: 100%;
            max-width: 220px;
            border-radius: 8px;
            background: #000;
            border: 1px solid #1e2d45;
        }
        
        .flex {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>

    <h1>MGV ‚Äî –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</h1>
    <p class="sub">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ</p>

    <!-- ‚îÄ‚îÄ 1. –ë—Ä–∞—É–∑–µ—Ä –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª ‚îÄ‚îÄ -->
    <div class="section">
        <h2>1. –°—Ä–µ–¥–∞</h2>
        <div class="row"><span class="label">URL –ø—Ä–æ—Ç–æ–∫–æ–ª</span><span class="val" id="env-proto">‚Äî</span></div>
        <div class="row"><span class="label">getUserMedia</span><span class="val" id="env-gum">‚Äî</span></div>
        <div class="row"><span class="label">RTCPeerConnection</span><span class="val" id="env-rtc">‚Äî</span></div>
        <div class="row"><span class="label">–ë—Ä–∞—É–∑–µ—Ä</span><span class="val" id="env-ua">‚Äî</span></div>
    </div>

    <!-- ‚îÄ‚îÄ 2. –ú–∏–∫—Ä–æ—Ñ–æ–Ω/–∫–∞–º–µ—Ä–∞ ‚îÄ‚îÄ -->
    <div class="section">
        <h2>2. –î–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞</h2>
        <button class="btn" onclick="testMedia('audio')">üé§ –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
        <button class="btn" onclick="testMedia('video')">üìπ –¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã</button>
        <button class="btn red" onclick="stopMedia()">‚èπ –°—Ç–æ–ø</button>
        <div class="flex" style="margin-top:12px">
            <video id="local-vid" autoplay muted playsinline></video>
            <div class="log" id="media-log" style="flex:1;min-width:200px"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ 3. TURN –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚îÄ‚îÄ -->
    <div class="section">
        <h2>3. STUN / TURN —Å–µ—Ä–≤–µ—Ä—ã</h2>
        <button class="btn" onclick="testIce()">‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ICE —Å–µ—Ä–≤–µ—Ä—ã</button>
        <div class="log" id="ice-log" style="margin-top:12px"></div>
    </div>

    <!-- ‚îÄ‚îÄ 4. WebSocket —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ ‚îÄ‚îÄ -->
    <div class="section">
        <h2>4. WebSocket —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ (–≤–æ–π–¥–∏ –ø–æ–¥ –¥–≤—É–º—è –∏–º–µ–Ω–∞–º–∏)</h2>
        <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap">
            <input id="ws-name" placeholder="–ò–º—è" style="background:#060a12;border:1px solid #1e2d45;color:#e2e8f0;padding:8px 12px;border-radius:8px;font-family:inherit;font-size:13px;width:140px">
            <input id="ws-pass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="background:#060a12;border:1px solid #1e2d45;color:#e2e8f0;padding:8px 12px;border-radius:8px;font-family:inherit;font-size:13px;width:140px">
            <button class="btn" onclick="wsConnect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            <button class="btn red" onclick="wsDisconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
        </div>
        <div class="row"><span class="label">WebSocket —Å—Ç–∞—Ç—É—Å</span><span class="status" id="ws-dot"></span><span class="val" id="ws-status">–Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</span></div>
        <div class="log" id="ws-log" style="margin-top:10px"></div>
    </div>

    <!-- ‚îÄ‚îÄ 5. –õ–æ–∫–∞–ª—å–Ω—ã–π P2P —Ç–µ—Å—Ç ‚îÄ‚îÄ -->
    <div class="section">
        <h2>5. –õ–æ–∫–∞–ª—å–Ω—ã–π P2P —Ç–µ—Å—Ç (–¥–≤–∞ PC –≤ –æ–¥–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)</h2>
        <button class="btn green" onclick="runLoopback()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å loopback —Ç–µ—Å—Ç</button>
        <button class="btn red" onclick="stopLoopback()">‚èπ –°—Ç–æ–ø</button>
        <div class="log" id="loop-log" style="margin-top:12px"></div>
        <div class="pair-box" style="margin-top:12px">
            <div class="peer-col">
                <h3>Caller (A)</h3>
                <div class="row"><span class="label">ICE state</span><span class="val" id="a-ice">‚Äî</span></div>
                <div class="row"><span class="label">Conn state</span><span class="val" id="a-conn">‚Äî</span></div>
                <div class="row"><span class="label">Tracks sent</span><span class="val" id="a-tracks">‚Äî</span></div>
            </div>
            <div class="peer-col">
                <h3>Callee (B)</h3>
                <div class="row"><span class="label">ICE state</span><span class="val" id="b-ice">‚Äî</span></div>
                <div class="row"><span class="label">Conn state</span><span class="val" id="b-conn">‚Äî</span></div>
                <video id="loop-vid" autoplay playsinline muted style="margin-top:8px"></video>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ
        function log(id, msg, cls) {
            var el = document.getElementById(id);
            var d = new Date(),
                t = d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0') + ':' + d.getSeconds().toString().padStart(2, '0');
            el.innerHTML += '<div class="' + (cls || 'info') + '">[' + t + '] ' + msg + '</div>';
            el.scrollTop = el.scrollHeight;
        }

        function set(id, val, cls) {
            var el = document.getElementById(id);
            if (!el) return;
            el.textContent = val;
            if (cls) {
                el.className = 'val';
                el.style.color = cls === 'ok' ? '#10b981' : cls === 'err' ? '#ef4444' : '#f59e0b';
            }
        }

        // ‚îÄ‚îÄ 1. Env check ‚îÄ‚îÄ
        (function() {
            var proto = location.protocol;
            set('env-proto', proto, proto === 'https:' ? 'ok' : 'warn');
            set('env-gum', navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? '‚úì –î–æ—Å—Ç—É–ø–µ–Ω' : '‚úó –ù–ï–¢', navigator.mediaDevices ? 'ok' : 'err');
            set('env-rtc', window.RTCPeerConnection ? '‚úì –î–æ—Å—Ç—É–ø–µ–Ω' : '‚úó –ù–ï–¢', window.RTCPeerConnection ? 'ok' : 'err');
            var ua = navigator.userAgent;
            var browser = ua.includes('Chrome') ? 'Chrome' : ua.includes('Firefox') ? 'Firefox' : ua.includes('Safari') ? 'Safari' : 'Other';
            set('env-ua', browser + ' ‚Äî ' + ua.slice(0, 80));
            if (proto !== 'https:' && location.hostname !== 'localhost') {
                log('media-log', '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–æ HTTP –Ω–µ –Ω–∞ localhost. getUserMedia –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º!', 'err');
            }
        })();

        // ‚îÄ‚îÄ 2. Media test ‚îÄ‚îÄ
        var localStream = null;
        async function testMedia(type) {
            try {
                log('media-log', '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º ' + type + '...', 'info');
                var constraints = type === 'video' ?
                    {
                        audio: true,
                        video: {
                            width: 320,
                            height: 240
                        }
                    } :
                    {
                        audio: true,
                        video: false
                    };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                log('media-log', '‚úì –ü–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω. –¢—Ä–µ–∫–æ–≤: ' + localStream.getTracks().length, 'ok');
                localStream.getTracks().forEach(function(t) {
                    log('media-log', '  ‚Üí ' + t.kind + ': ' + t.label, 'dim');
                });
                if (type === 'video') document.getElementById('local-vid').srcObject = localStream;
            } catch (e) {
                log('media-log', '‚úó –û—à–∏–±–∫–∞: ' + e.name + ': ' + e.message, 'err');
            }
        }

        function stopMedia() {
            if (localStream) {
                localStream.getTracks().forEach(function(t) {
                    t.stop();
                });
                localStream = null;
            }
            document.getElementById('local-vid').srcObject = null;
            log('media-log', '–ú–µ–¥–∏–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'dim');
        }

        // ‚îÄ‚îÄ 3. ICE / TURN test ‚îÄ‚îÄ
        var ICE_SERVERS = [{
            urls: 'stun:stun.l.google.com:19302'
        }, {
            urls: 'stun:stun1.l.google.com:19302'
        }, {
            urls: 'stun:stun.cloudflare.com:3478'
        }, {
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }, {
            urls: 'turn:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }, {
            urls: 'turn:openrelay.metered.ca:443?transport=tcp',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }, {
            urls: 'turns:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }];

        async function testIce() {
            var el = document.getElementById('ice-log');
            el.innerHTML = '';
            log('ice-log', '–°–æ–∑–¥–∞—ë–º RTCPeerConnection —Å STUN/TURN —Å–µ—Ä–≤–µ—Ä–∞–º–∏...', 'info');
            var pc = new RTCPeerConnection({
                iceServers: ICE_SERVERS
            });
            var found = {
                stun: false,
                turn: false,
                turns: false
            };
            var done = false;

            pc.onicecandidate = function(e) {
                if (!e.candidate) {
                    if (!done) {
                        done = true;
                        log('ice-log', '--- –°–±–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω ---', 'dim');
                        if (found.stun) log('ice-log', '‚úì STUN —Ä–∞–±–æ—Ç–∞–µ—Ç (srflx –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª—É—á–µ–Ω)', 'ok');
                        else log('ice-log', '‚úó STUN –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –Ω–µ—Ç srflx –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤', 'err');
                        if (found.turn) log('ice-log', '‚úì TURN —Ä–∞–±–æ—Ç–∞–µ—Ç (relay –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª—É—á–µ–Ω)', 'ok');
                        else log('ice-log', '‚úó TURN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –Ω–µ—Ç relay –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤! –ó–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ NAT –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.', 'err');
                        if (found.turns) log('ice-log', '‚úì TURNS (TLS) —Ä–∞–±–æ—Ç–∞–µ—Ç', 'ok');
                        pc.close();
                    }
                    return;
                }
                var c = e.candidate;
                var type = c.type || (c.candidate.includes('typ relay') ? 'relay' : c.candidate.includes('typ srflx') ? 'srflx' : c.candidate.includes('typ host') ? 'host' : '?');
                if (!type || type === '?') {
                    var m = c.candidate.match(/typ (\w+)/);
                    type = m ? m[1] : '?';
                }
                var cls = type === 'relay' ? 'ok' : type === 'srflx' ? 'ok' : 'dim';
                log('ice-log', '–ö–∞–Ω–¥–∏–¥–∞—Ç: typ=' + type + ' | ' + c.candidate.slice(0, 80), cls);
                if (type === 'srflx') found.stun = true;
                if (type === 'relay' && !c.candidate.includes('turns')) found.turn = true;
                if (type === 'relay' && c.candidate.includes('turns')) found.turns = true;
            };

            // –ù—É–∂–µ–Ω –æ—Ñ—Ñ–µ—Ä —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å ICE gathering
            pc.addTransceiver('audio');
            var offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            setTimeout(function() {
                if (!done) {
                    done = true;
                    log('ice-log', '–¢–∞–π–º–∞—É—Ç 10—Å ‚Äî –∏—Ç–æ–≥ –≤—ã—à–µ', 'warn');
                    pc.close();
                }
            }, 10000);
        }

        // ‚îÄ‚îÄ 4. WebSocket ‚îÄ‚îÄ
        var testWs = null;

        function wsConnect() {
            var name = document.getElementById('ws-name').value.trim();
            var pass = document.getElementById('ws-pass').value;
            if (!name || !pass) {
                log('ws-log', '–í–≤–µ–¥–∏ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å', 'warn');
                return;
            }
            var proto = location.protocol === 'https:' ? 'wss' : 'ws';
            var url = proto + '://' + location.host;
            log('ws-log', '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ ' + url + '...', 'info');
            testWs = new WebSocket(url);
            testWs.onopen = function() {
                document.getElementById('ws-dot').className = 'status yellow';
                set('ws-status', '–ø–æ–¥–∫–ª—é—á—ë–Ω, –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è...');
                testWs.send(JSON.stringify({
                    type: 'auth',
                    name: name,
                    pass: pass
                }));
            };
            testWs.onmessage = function(e) {
                var m;
                try {
                    m = JSON.parse(e.data);
                } catch (err) {
                    return;
                }
                if (m.type === 'auth-ok') {
                    document.getElementById('ws-dot').className = 'status green';
                    set('ws-status', '–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ' + m.name, 'ok');
                    log('ws-log', '‚úì Auth OK. –†–æ–ª—å: ' + m.role, 'ok');
                } else if (m.type === 'auth-fail') {
                    log('ws-log', '‚úó Auth fail: ' + m.reason, 'err');
                } else if (m.type === 'online') {
                    log('ws-log', '–û–Ω–ª–∞–π–Ω: ' + m.users.join(', '), 'dim');
                } else if (m.type === 'call-offer') {
                    log('ws-log', '‚úì –ü–æ–ª—É—á–µ–Ω call-offer –æ—Ç ' + m.from + ' ‚Äî —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'ok');
                } else {
                    log('ws-log', 'msg: ' + m.type, 'dim');
                }
            };
            testWs.onclose = function() {
                document.getElementById('ws-dot').className = 'status red';
                set('ws-status', '–æ—Ç–∫–ª—é—á—ë–Ω');
                log('ws-log', 'WebSocket –∑–∞–∫—Ä—ã—Ç', 'warn');
            };
            testWs.onerror = function(e) {
                log('ws-log', '‚úó WebSocket –æ—à–∏–±–∫–∞', 'err');
            };
        }

        function wsDisconnect() {
            if (testWs) {
                testWs.close();
                testWs = null;
            }
        }

        // ‚îÄ‚îÄ 5. Loopback P2P —Ç–µ—Å—Ç ‚îÄ‚îÄ
        var pcA = null,
            pcB = null,
            loopStream = null;
        async function runLoopback() {
            var llog = document.getElementById('loop-log');
            llog.innerHTML = '';
            stopLoopback();

            log('loop-log', '–ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞...', 'info');
            try {
                loopStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: false
                });
                log('loop-log', '‚úì –ú–µ–¥–∏–∞ –ø–æ–ª—É—á–µ–Ω', 'ok');
            } catch (e) {
                log('loop-log', '‚úó –ù–µ—Ç –º–µ–¥–∏–∞: ' + e.message + '. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫.', 'warn');
                // –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ AudioContext
                var ac = new AudioContext();
                var osc = ac.createOscillator();
                var dst = ac.createMediaStreamDestination();
                osc.connect(dst);
                osc.start();
                loopStream = dst.stream;
            }

            pcA = new RTCPeerConnection({
                iceServers: ICE_SERVERS
            });
            pcB = new RTCPeerConnection({
                iceServers: ICE_SERVERS
            });

            loopStream.getTracks().forEach(function(t) {
                pcA.addTrack(t, loopStream);
            });
            set('a-tracks', loopStream.getTracks().length + ' —Ç—Ä–µ–∫–∞');

            // ICE –æ–±–º–µ–Ω –º–µ–∂–¥—É A –∏ B (–ª–æ–∫–∞–ª—å–Ω–æ)
            pcA.onicecandidate = function(e) {
                if (e.candidate) {
                    pcB.addIceCandidate(e.candidate).catch(function(err) {
                        log('loop-log', 'B addIce: ' + err.message, 'warn');
                    });
                }
            };
            pcB.onicecandidate = function(e) {
                if (e.candidate) {
                    pcA.addIceCandidate(e.candidate).catch(function(err) {
                        log('loop-log', 'A addIce: ' + err.message, 'warn');
                    });
                }
            };

            pcA.oniceconnectionstatechange = function() {
                set('a-ice', pcA.iceConnectionState);
                log('loop-log', 'A ICE ‚Üí ' + pcA.iceConnectionState, pcA.iceConnectionState === 'connected' || pcA.iceConnectionState === 'completed' ? 'ok' : 'info');
            };
            pcB.oniceconnectionstatechange = function() {
                set('b-ice', pcB.iceConnectionState);
            };
            pcA.onconnectionstatechange = function() {
                set('a-conn', pcA.connectionState);
                if (pcA.connectionState === 'connected') log('loop-log', '‚úì‚úì‚úì P2P –°–û–ï–î–ò–ù–ï–ù–û! WebRTC —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.', 'ok');
                if (pcA.connectionState === 'failed') log('loop-log', '‚úó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å', 'err');
            };
            pcB.onconnectionstatechange = function() {
                set('b-conn', pcB.connectionState);
            };

            pcB.ontrack = function(e) {
                log('loop-log', '‚úì B –ø–æ–ª—É—á–∏–ª —Ç—Ä–µ–∫: ' + e.track.kind, 'ok');
                document.getElementById('loop-vid').srcObject = e.streams[0];
            };

            // Offer/answer
            log('loop-log', 'A createOffer...', 'info');
            var offer = await pcA.createOffer();
            await pcA.setLocalDescription(offer);
            await pcB.setRemoteDescription(offer);

            log('loop-log', 'B createAnswer...', 'info');
            var answer = await pcB.createAnswer();
            await pcB.setLocalDescription(answer);
            await pcA.setRemoteDescription(answer);
            log('loop-log', 'SDP –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω, –∂–¥—ë–º ICE...', 'info');
        }

        function stopLoopback() {
            if (pcA) {
                pcA.close();
                pcA = null;
            }
            if (pcB) {
                pcB.close();
                pcB = null;
            }
            if (loopStream) {
                loopStream.getTracks().forEach(function(t) {
                    t.stop();
                });
                loopStream = null;
            }
            document.getElementById('loop-vid').srcObject = null;
        }
    </script>
</body>

</html>