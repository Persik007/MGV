<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MGV — Диагностика звонков</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0f1a;
            color: #e2e8f0;
            padding: 20px;
            font-size: 13px
        }
        
        h1 {
            color: #3b82f6;
            font-size: 20px;
            margin-bottom: 4px
        }
        
        .sub {
            color: #4a5568;
            font-size: 11px;
            margin-bottom: 24px
        }
        
        .card {
            background: #0d1117;
            border: 1px solid #1e2d45;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px
        }
        
        .card h2 {
            font-size: 11px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #4a5568;
            margin-bottom: 12px
        }
        
        .btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            margin-right: 8px;
            margin-bottom: 8px
        }
        
        .btn:hover {
            background: #2563eb
        }
        
        .btn.red {
            background: #ef4444
        }
        
        .btn.grn {
            background: #10b981
        }
        
        .log {
            background: #060a12;
            border: 1px solid #1e2d45;
            border-radius: 8px;
            padding: 12px;
            min-height: 60px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.8;
            margin-top: 10px
        }
        
        .ok {
            color: #10b981
        }
        
        .err {
            color: #ef4444
        }
        
        .warn {
            color: #f59e0b
        }
        
        .info {
            color: #60a5fa
        }
        
        .dim {
            color: #4a5568
        }
        
        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px
        }
        
        .lbl {
            color: #4a5568;
            width: 180px;
            flex-shrink: 0
        }
        
        .val {
            font-weight: 600
        }
        
        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4a5568;
            margin-right: 6px
        }
        
        .dot.g {
            background: #10b981;
            box-shadow: 0 0 6px #10b981
        }
        
        .dot.r {
            background: #ef4444
        }
        
        .dot.y {
            background: #f59e0b;
            animation: blink 1s infinite
        }
        
        @keyframes blink {
            0%,
            100% {
                opacity: 1
            }
            50% {
                opacity: .3
            }
        }
        
        input {
            background: #060a12;
            border: 1px solid #1e2d45;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            width: 140px
        }
    </style>
</head>

<body>
    <h1>MGV — Диагностика звонков</h1>
    <p class="sub">Последовательно запускай тесты — они покажут где именно проблема</p>

    <!-- 1. Среда -->
    <div class="card">
        <h2>1. Среда браузера</h2>
        <div class="row"><span class="lbl">Протокол страницы</span><span class="val" id="e-proto">—</span></div>
        <div class="row"><span class="lbl">getUserMedia</span><span class="val" id="e-gum">—</span></div>
        <div class="row"><span class="lbl">RTCPeerConnection</span><span class="val" id="e-rtc">—</span></div>
    </div>

    <!-- 2. /api/ice -->
    <div class="card">
        <h2>2. ICE серверы (загружает с /api/ice)</h2>
        <button class="btn" onclick="testApiIce()">▶ Загрузить /api/ice</button>
        <div class="log" id="ice-api-log"></div>
    </div>

    <!-- 3. TURN проверка -->
    <div class="card">
        <h2>3. TURN проверка (используются серверы из п.2)</h2>
        <button class="btn" onclick="testTurn()">▶ Проверить relay кандидаты</button>
        <div class="log" id="turn-log"></div>
    </div>

    <!-- 4. Микрофон -->
    <div class="card">
        <h2>4. Микрофон</h2>
        <button class="btn" onclick="testMic()">▶ Тест микрофона</button>
        <button class="btn red" onclick="stopMic()">⏹ Стоп</button>
        <div class="log" id="mic-log"></div>
    </div>

    <!-- 5. WebSocket -->
    <div class="card">
        <h2>5. WebSocket сигналинг</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
            <input id="ws-name" placeholder="Имя">
            <input id="ws-pass" placeholder="Пароль" type="password">
            <button class="btn" onclick="wsConn()">Подключить</button>
            <button class="btn red" onclick="wsDisc()">Отключить</button>
        </div>
        <div class="row"><span class="lbl">Статус</span><span class="dot" id="ws-dot"></span><span class="val" id="ws-st">не подключён</span></div>
        <div class="log" id="ws-log"></div>
    </div>

    <!-- 6. Loopback -->
    <div class="card">
        <h2>6. Loopback P2P тест (два PC в одном браузере)</h2>
        <button class="btn grn" onclick="loopStart()">▶ Запустить</button>
        <button class="btn red" onclick="loopStop()">⏹ Стоп</button>
        <div class="log" id="loop-log"></div>
        <div style="display:flex;gap:20px;margin-top:12px;flex-wrap:wrap">
            <div>
                <div class="row"><span class="lbl">A ICE state</span><span class="val" id="a-ice">—</span></div>
                <div class="row"><span class="lbl">A conn state</span><span class="val" id="a-conn">—</span></div>
            </div>
            <div>
                <div class="row"><span class="lbl">B ICE state</span><span class="val" id="b-ice">—</span></div>
                <div class="row"><span class="lbl">B conn state</span><span class="val" id="b-conn">—</span></div>
            </div>
        </div>
    </div>

    <script>
        // ── helpers ──
        function L(id, msg, cls) {
            var el = document.getElementById(id);
            var t = new Date().toTimeString().slice(0, 8);
            el.innerHTML += '<div class="' + (cls || 'info') + '">[' + t + '] ' + msg + '</div>';
            el.scrollTop = el.scrollHeight;
        }

        function V(id, val, cls) {
            var el = document.getElementById(id);
            if (!el) return;
            el.textContent = val;
            el.style.color = cls === 'ok' ? '#10b981' : cls === 'err' ? '#ef4444' : cls === 'warn' ? '#f59e0b' : '';
        }

        // ── 1. Env ──
        (function() {
            var proto = location.protocol;
            V('e-proto', proto, proto === 'https:' ? 'ok' : 'warn');
            var gum = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            V('e-gum', gum ? '✓ Доступен' : '✗ НЕТ', gum ? 'ok' : 'err');
            var rtc = !!window.RTCPeerConnection;
            V('e-rtc', rtc ? '✓ Доступен' : '✗ НЕТ', rtc ? 'ok' : 'err');
            if (proto !== 'https:' && location.hostname !== 'localhost') {
                setTimeout(function() {
                    L('mic-log', '⚠️ Страница открыта по HTTP — getUserMedia заблокирован браузером!', 'err');
                }, 100);
            }
        })();

        // ── ICE серверы (загружаем с сервера) ──
        var LOADED_ICE = null;

        async function testApiIce() {
            L('ice-api-log', 'Запрашиваем GET /api/ice...', 'info');
            try {
                var r = await fetch('/api/ice');
                var data = await r.json();
                LOADED_ICE = data;
                L('ice-api-log', '✓ Получено ' + data.length + ' серверов:', 'ok');
                data.forEach(function(s) {
                    var hasCred = s.username ? ' [auth ✓]' : ' [no auth]';
                    L('ice-api-log', '  ' + s.urls + hasCred, 'dim');
                });
                var hasTurn = data.some(function(s) {
                    return String(s.urls).startsWith('turn');
                });
                if (hasTurn) {
                    L('ice-api-log', '✓ TURN серверы присутствуют — теперь запусти тест п.3', 'ok');
                } else {
                    L('ice-api-log', '⚠️ TURN серверов нет! Только STUN. Звонки через NAT не будут работать.', 'err');
                }
            } catch (e) {
                L('ice-api-log', '✗ Ошибка: ' + e.message, 'err');
            }
        }

        // ── TURN relay тест ──
        async function testTurn() {
            if (!LOADED_ICE) {
                L('turn-log', 'Сначала запусти тест п.2!', 'warn');
                return;
            }
            L('turn-log', 'Создаём RTCPeerConnection с ' + LOADED_ICE.length + ' серверами...', 'info');
            var pc = new RTCPeerConnection({
                iceServers: LOADED_ICE,
                iceCandidatePoolSize: 4
            });
            var found = {
                host: 0,
                srflx: 0,
                relay: 0
            };
            var done = false;

            pc.onicecandidate = function(e) {
                if (!e.candidate) {
                    if (done) return;
                    done = true;
                    L('turn-log', '--- Сбор завершён ---', 'dim');
                    L('turn-log', 'host: ' + found.host + ', srflx(STUN): ' + found.srflx + ', relay(TURN): ' + found.relay,
                        found.relay > 0 ? 'ok' : 'warn');
                    if (found.relay > 0) L('turn-log', '✓✓✓ TURN работает! Звонки должны соединяться.', 'ok');
                    else L('turn-log', '✗ relay кандидатов НЕТ — TURN недоступен или заблокирован провайдером.', 'err');
                    pc.close();
                    return;
                }
                var c = e.candidate.candidate;
                var m = c.match(/typ (\w+)/);
                var typ = m ? m[1] : '?';
                if (found[typ] !== undefined) found[typ]++;
                var cls = typ === 'relay' ? 'ok' : typ === 'srflx' ? 'ok' : 'dim';
                L('turn-log', 'typ=' + typ + ' | ' + c.slice(0, 90), cls);
            };

            pc.addTransceiver('audio');
            var offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            setTimeout(function() {
                if (!done) {
                    done = true;
                    L('turn-log', 'Таймаут 15с — итог выше', 'warn');
                    pc.close();
                }
            }, 15000);
        }

        // ── Микрофон ──
        var micStream = null;
        async function testMic() {
            try {
                L('mic-log', 'Запрашиваем микрофон...', 'info');
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                L('mic-log', '✓ Микрофон доступен: ' + micStream.getAudioTracks()[0].label, 'ok');
            } catch (e) {
                L('mic-log', '✗ ' + e.name + ': ' + e.message, 'err');
            }
        }

        function stopMic() {
            if (micStream) {
                micStream.getTracks().forEach(function(t) {
                    t.stop();
                });
                micStream = null;
            }
            L('mic-log', 'Остановлен', 'dim');
        }

        // ── WebSocket ──
        var testWs = null;

        function wsConn() {
            var name = document.getElementById('ws-name').value.trim();
            var pass = document.getElementById('ws-pass').value;
            if (!name || !pass) {
                L('ws-log', 'Введи имя и пароль', 'warn');
                return;
            }
            var url = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host;
            L('ws-log', 'Подключаемся к ' + url, 'info');
            testWs = new WebSocket(url);
            testWs.onopen = function() {
                document.getElementById('ws-dot').className = 'dot y';
                V('ws-st', 'подключён, авторизуемся...');
                testWs.send(JSON.stringify({
                    type: 'auth',
                    name: name,
                    pass: pass
                }));
            };
            testWs.onmessage = function(e) {
                var m;
                try {
                    m = JSON.parse(e.data);
                } catch (ex) {
                    return;
                }
                if (m.type === 'auth-ok') {
                    document.getElementById('ws-dot').className = 'dot g';
                    V('ws-st', '✓ авторизован как ' + m.name, 'ok');
                    L('ws-log', '✓ auth-ok, роль: ' + m.role, 'ok');
                } else if (m.type === 'auth-fail') {
                    L('ws-log', '✗ ' + m.reason, 'err');
                } else if (m.type === 'online') {
                    L('ws-log', 'Онлайн: ' + m.users.join(', '), 'dim');
                } else if (m.type === 'call-offer') {
                    L('ws-log', '✓ Получен call-offer от ' + m.from + ' — сигналинг работает!', 'ok');
                } else {
                    L('ws-log', m.type, 'dim');
                }
            };
            testWs.onclose = function() {
                document.getElementById('ws-dot').className = 'dot r';
                V('ws-st', 'отключён');
                L('ws-log', 'WebSocket закрыт', 'warn');
            };
            testWs.onerror = function() {
                L('ws-log', '✗ Ошибка подключения', 'err');
            };
        }

        function wsDisc() {
            if (testWs) {
                testWs.close();
                testWs = null;
            }
        }

        // ── Loopback ──
        var pcA = null,
            pcB = null,
            loopSt = null;
        async function loopStart() {
            loopStop();
            if (!LOADED_ICE) {
                // загрузим автоматически
                try {
                    var r = await fetch('/api/ice');
                    LOADED_ICE = await r.json();
                } catch (e) {
                    LOADED_ICE = [{
                        urls: 'stun:stun.l.google.com:19302'
                    }];
                }
            }
            L('loop-log', 'Получаем медиа...', 'info');
            try {
                loopSt = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: false
                });
                L('loop-log', '✓ Микрофон получен', 'ok');
            } catch (e) {
                L('loop-log', 'Нет микрофона (' + e.message + '), используем синтетический поток', 'warn');
                var ac = new AudioContext(),
                    osc = ac.createOscillator(),
                    dst = ac.createMediaStreamDestination();
                osc.connect(dst);
                osc.start();
                loopSt = dst.stream;
            }

            pcA = new RTCPeerConnection({
                iceServers: LOADED_ICE
            });
            pcB = new RTCPeerConnection({
                iceServers: LOADED_ICE
            });
            loopSt.getTracks().forEach(function(t) {
                pcA.addTrack(t, loopSt);
            });

            pcA.onicecandidate = function(e) {
                if (e.candidate) pcB.addIceCandidate(e.candidate).catch(function() {});
            };
            pcB.onicecandidate = function(e) {
                if (e.candidate) pcA.addIceCandidate(e.candidate).catch(function() {});
            };

            pcA.oniceconnectionstatechange = function() {
                V('a-ice', pcA.iceConnectionState);
                L('loop-log', 'A ICE → ' + pcA.iceConnectionState, pcA.iceConnectionState === 'connected' || pcA.iceConnectionState === 'completed' ? 'ok' : 'info');
            };
            pcB.oniceconnectionstatechange = function() {
                V('b-ice', pcB.iceConnectionState);
            };
            pcA.onconnectionstatechange = function() {
                V('a-conn', pcA.connectionState);
                if (pcA.connectionState === 'connected') L('loop-log', '✓✓✓ P2P СОЕДИНЕНО! WebRTC работает.', 'ok');
                if (pcA.connectionState === 'failed') L('loop-log', '✗ Соединение провалилось', 'err');
            };
            pcB.onconnectionstatechange = function() {
                V('b-conn', pcB.connectionState);
            };
            pcB.ontrack = function(e) {
                L('loop-log', '✓ B получил трек: ' + e.track.kind, 'ok');
            };

            var offer = await pcA.createOffer();
            await pcA.setLocalDescription(offer);
            await pcB.setRemoteDescription(offer);
            var answer = await pcB.createAnswer();
            await pcB.setLocalDescription(answer);
            await pcA.setRemoteDescription(answer);
            L('loop-log', 'SDP обмен завершён, ждём ICE...', 'info');
        }

        function loopStop() {
            if (pcA) {
                pcA.close();
                pcA = null;
            }
            if (pcB) {
                pcB.close();
                pcB = null;
            }
            if (loopSt) {
                loopSt.getTracks().forEach(function(t) {
                    t.stop();
                });
                loopSt = null;
            }
        }
    </script>
</body>

</html>