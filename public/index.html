<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="theme-color" content="#080b12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MGV</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        /* ‚ïê‚ïê Only component-specific styles here, layout in style.css ‚ïê‚ïê */
        
        #app {
            display: none;
        }
        
        #app.visible {
            display: flex;
            flex-direction: column;
        }
        /* ‚îÄ‚îÄ Voice pill (Telegram-style) ‚îÄ‚îÄ */
        
        .voice-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 24px;
            padding: 9px 14px;
            min-width: 210px;
            max-width: 290px;
            background: var(--bg4);
            border: 1px solid var(--border);
            user-select: none;
        }
        
        .msg-row.own .voice-pill {
            background: var(--own-msg);
            border-color: var(--own-border);
        }
        
        .vp-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: var(--accent);
            color: #fff;
            font-size: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .msg-row.own .vp-btn {
            background: rgba(255, 255, 255, .22);
        }
        
        .vp-track {
            flex: 1;
            height: 34px;
            position: relative;
            cursor: pointer;
            min-width: 0;
        }
        
        .vp-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .vp-dur {
            font-size: 11px;
            color: var(--text3);
            flex-shrink: 0;
            min-width: 32px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        
        .msg-row.own .vp-dur {
            color: rgba(255, 255, 255, .5);
        }
        /* ‚îÄ‚îÄ Voice recorder bar ‚îÄ‚îÄ */
        
        #voice-recorder {
            display: none;
            align-items: center;
            gap: 10px;
            background: var(--bg4);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 14px;
            margin-bottom: 8px;
        }
        
        #voice-recorder.active {
            display: flex;
        }
        
        .rec-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--red);
            flex-shrink: 0;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%,
            100% {
                opacity: 1
            }
            50% {
                opacity: .1
            }
        }
        
        .rec-time {
            font-size: 13px;
            color: var(--text);
            min-width: 36px;
            flex-shrink: 0;
            font-variant-numeric: tabular-nums;
        }
        
        #rec-wave {
            flex: 1;
            height: 26px;
            min-width: 0;
        }
        
        .rec-x {
            background: none;
            border: none;
            color: var(--text3);
            font-size: 22px;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0 4px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .rec-ok {
            background: var(--green);
            border: none;
            color: #fff;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 17px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ‚îÄ‚îÄ Circle message ‚îÄ‚îÄ */
        /* circle styles moved to style.css */
        /* ‚îÄ‚îÄ Circle recorder ‚îÄ‚îÄ */
        
        #circle-recorder {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(4, 4, 12, .95);
            z-index: 700;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            backdrop-filter: blur(14px);
        }
        
        #circle-recorder.active {
            display: flex;
        }
        
        .cr-wrap {
            position: relative;
            width: 260px;
            height: 260px;
        }
        
        .cr-svg {
            position: absolute;
            top: -12px;
            left: -12px;
            width: 284px;
            height: 284px;
            transform: rotate(-90deg);
            pointer-events: none;
        }
        
        .cr-bg {
            fill: none;
            stroke: rgba(255, 255, 255, .06);
            stroke-width: 6;
        }
        
        #cr-prog {
            fill: none;
            stroke: var(--red);
            stroke-width: 6;
            stroke-linecap: round;
            stroke-dasharray: 754;
            stroke-dashoffset: 754;
            transition: stroke-dashoffset 1s linear;
        }
        
        .cr-clip {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(239, 68, 68, .5);
            box-shadow: 0 0 50px rgba(239, 68, 68, .28);
        }
        
        #cr-vid {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .cr-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, .55);
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .cr-time {
            font-size: 30px;
            color: #fff;
            font-variant-numeric: tabular-nums;
        }
        
        .cr-btns {
            display: flex;
            gap: 18px;
        }
        
        .cr-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .cr-cancel {
            background: rgba(255, 255, 255, .1);
            color: #fff;
        }
        
        .cr-ok {
            background: var(--green);
            color: #fff;
        }
        /* ‚îÄ‚îÄ Call overlay ‚îÄ‚îÄ */
        
        #call-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 500;
        }
        
        #call-overlay.active {
            display: block;
        }
        
        #remote-vid {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        #call-bg {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
            background: radial-gradient(ellipse at center, #0d1e38, #060a12);
        }
        
        .ca-ring {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ca-ring::before,
        .ca-ring::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(16, 185, 129, .22);
            animation: caRing 2s ease-in-out infinite;
        }
        
        .ca-ring::before {
            inset: -10px;
        }
        
        .ca-ring::after {
            inset: -22px;
            animation-delay: .5s;
        }
        
        @keyframes caRing {
            0%,
            100% {
                opacity: .9
            }
            50% {
                opacity: .1
            }
        }
        
        #call-av {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 700;
            border: 3px solid var(--green);
        }
        
        #call-name {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            font-family: var(--font-h);
        }
        
        #call-st {
            font-size: 11px;
            color: rgba(255, 255, 255, .4);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        #call-tmr {
            font-size: 30px;
            color: var(--green);
            min-height: 36px;
            font-variant-numeric: tabular-nums;
        }
        
        #call-topbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 5;
            background: linear-gradient(to bottom, rgba(0, 0, 0, .7), transparent);
            padding: 14px 18px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        #call-tb-name {
            font-size: 15px;
            font-weight: 700;
            color: #fff;
        }
        
        #call-tb-tmr {
            margin-left: auto;
            font-size: 14px;
            color: rgba(255, 255, 255, .5);
            font-variant-numeric: tabular-nums;
        }
        
        #call-pip {
            position: absolute;
            bottom: 110px;
            right: 18px;
            width: 120px;
            height: 88px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, .15);
            display: none;
            z-index: 8;
        }
        
        #call-pip video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .call-btns {
            position: absolute;
            bottom: 36px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 14px;
            z-index: 10;
        }
        
        .cbtn {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .cbtn-mic {
            background: rgba(255, 255, 255, .12);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .12);
        }
        
        .cbtn-mic.off {
            background: var(--yellow);
            color: #000;
        }
        
        .cbtn-cam {
            background: rgba(255, 255, 255, .12);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .12);
        }
        
        .cbtn-cam.off {
            background: var(--red);
            color: #fff;
        }
        
        .cbtn-end {
            background: var(--red);
            color: #fff;
        }
        /* ‚îÄ‚îÄ Incoming call ‚îÄ‚îÄ */
        
        #incoming {
            position: fixed;
            bottom: 22px;
            right: 22px;
            background: var(--bg2);
            border: 1px solid var(--green);
            border-radius: 16px;
            padding: 18px 22px;
            display: none;
            flex-direction: column;
            gap: 12px;
            min-width: 270px;
            z-index: 600;
            box-shadow: 0 8px 40px rgba(16, 185, 129, .2);
        }
        
        #incoming.active {
            display: flex;
            animation: slideUp .25s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(8px)
            }
            to {
                opacity: 1;
                transform: translateY(0)
            }
        }
        
        #inc-label {
            font-size: 10px;
            color: var(--green);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        #inc-name {
            font-size: 18px;
            font-weight: 700;
            font-family: var(--font-h);
        }
        
        .inc-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        /* ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ */
        
        #lbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .94);
            align-items: center;
            justify-content: center;
            z-index: 600;
            cursor: zoom-out;
        }
        
        #lbox.active {
            display: flex;
        }
        
        #lbox img {
            max-width: 94vw;
            max-height: 92vh;
            border-radius: 8px;
        }
        /* ‚îÄ‚îÄ Inline video in messages ‚îÄ‚îÄ */
        
        .msg-vid {
            max-width: 290px;
            width: 100%;
            border-radius: 10px;
            display: block;
            border: 1px solid var(--border);
        }
    </style>
</head>

<body>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="login-screen" style="display:flex">
        <div class="login-box">
            <div class="login-logo">MGV<span>.</span></div>
            <div class="login-tag">Secure Messenger</div>
            <div id="login-err" class="login-err"></div>
            <label class="lbl">–ò–º—è</label>
            <input class="inp" id="l-name" type="text" placeholder="username" maxlength="30" autocomplete="username">
            <label class="lbl">–ü–∞—Ä–æ–ª—å</label>
            <input class="inp" id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            <button class="btn" id="login-btn">‚Üí –í–û–ô–¢–ò / –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="app">

        <!-- Desktop topbar (hidden on mobile via CSS) -->
        <div class="topbar">
            <div class="topbar-logo">MGV<span>.</span></div>
            <div class="topbar-right">
                <div class="user-chip">
                    <div class="online-dot" id="conn-dot"></div>
                    <span id="topbar-user">‚Äî</span>
                </div>
                <a id="admin-link" class="icon-btn" href="/admin.html" target="_blank" style="display:none;text-decoration:none">‚öôÔ∏è</a>
                <button class="icon-btn" onclick="MGV.doLogout()">üö™</button>
            </div>
        </div>

        <div class="desk-layout" id="desk-layout">

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN A: LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="sidebar">

                <!-- Mobile header (list screen) -->
                <div class="mob-nav">
                    <div class="mob-logo">MGV<span>.</span></div>
                    <div class="mob-right">
                        <div class="mob-user">
                            <div class="online-dot" id="conn-dot-m" style="width:7px;height:7px;border-radius:50%;background:var(--text3)"></div>
                            <span id="topbar-user-m">‚Äî</span>
                        </div>
                        <button class="icon-btn" onclick="MGV.doLogout()" style="font-size:17px">üö™</button>
                    </div>
                </div>

                <!-- Tabs: Channels / DMs -->
                <div class="s-tabs">
                    <button class="s-tab on" id="tab-ch" onclick="MGV.switchTab('ch')">
          <span>#</span><span>–ö–∞–Ω–∞–ª—ã</span>
          <span class="s-badge" id="badge-ch"></span>
        </button>
                    <button class="s-tab" id="tab-dm" onclick="MGV.switchTab('dm')">
          <span>üí¨</span><span>–ß–∞—Ç—ã</span>
          <span class="s-badge" id="badge-dm"></span>
        </button>
                </div>

                <!-- Lists -->
                <div id="panel-ch" class="s-list">
                    <div id="channel-list"></div>
                </div>
                <div id="panel-dm" class="s-list" style="display:none">
                    <div id="online-list"></div>
                </div>

                <div class="s-actions">
                    <button class="btn btn-ghost btn-sm" id="btn-add-ch" onclick="MGV.openCreateChannel()" style="display:none;width:100%">+ –ö–∞–Ω–∞–ª</button>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN B: CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="chat-col">

                <!-- Mobile chat header -->
                <div class="mob-nav" id="mob-chat-nav">
                    <button class="mob-back show" onclick="MGV.goBack()">‚Äπ</button>
                    <div class="mob-chat-title">
                        <h2 id="mob-chat-name">‚Äî</h2>
                        <p id="mob-chat-sub"></p>
                    </div>
                    <div class="mob-right">
                        <div id="mob-call-btns" style="display:none;gap:6px;display:flex">
                            <button class="icon-btn" onclick="MGV.startCall('audio')">üìû</button>
                            <button class="icon-btn" onclick="MGV.startCall('video')">üìπ</button>
                        </div>
                    </div>
                </div>

                <!-- Desktop no-chat placeholder -->
                <div class="no-chat" id="no-chat">
                    <div class="no-chat-logo">MGV<span>.</span></div>
                    <div style="font-size:13px;color:var(--text3)">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –∏–ª–∏ —á–∞—Ç</div>
                </div>

                <!-- Chat view -->
                <div id="chat-view" style="display:none;flex-direction:column;flex:1;overflow:hidden">

                    <!-- Desktop chat header -->
                    <div class="chat-header">
                        <span class="chat-header-icon">#</span>
                        <div>
                            <span class="chat-header-name" id="chat-name">‚Äî</span>
                            <span class="chat-header-desc" id="chat-desc"></span>
                        </div>
                        <div class="chat-header-right" id="call-buttons" style="display:none;gap:6px">
                            <button class="icon-btn" onclick="MGV.startCall('audio')">üìû</button>
                            <button class="icon-btn" onclick="MGV.startCall('video')">üìπ</button>
                        </div>
                    </div>

                    <div id="messages"></div>
                    <div class="typing-indicator" id="typing-indicator"></div>

                    <div class="input-area">
                        <div id="upload-preview" style="display:none" class="upload-preview">
                            <span>üìé</span>
                            <span class="up-name" id="upload-preview-name">‚Äî</span>
                            <button class="upload-cancel" id="upload-cancel-btn">‚úï</button>
                        </div>
                        <div id="voice-recorder">
                            <div class="rec-dot"></div>
                            <span class="rec-time" id="rec-time">0:00</span>
                            <canvas id="rec-wave" height="26"></canvas>
                            <button class="rec-x" id="rec-cancel">‚úï</button>
                            <button class="rec-ok" id="rec-send">‚úì</button>
                        </div>
                        <div id="emoji-input-panel" class="emoji-input-panel"></div>
                        <div class="input-row">
                            <div class="input-actions">
                                <button class="input-icon-btn" onclick="MGV.attachFile()">üìé</button>
                                <button class="input-icon-btn" id="btn-emoji" onclick="MGV.toggleEmojiInput(event)" title="–≠–º–æ–¥–∑–∏">üòä</button>
                            </div>
                            <textarea id="msg-input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                            <div class="input-actions">
                                <button class="input-icon-btn" id="btn-voice" onclick="MGV.startVoice()" style="font-size:19px">üé§</button>
                                <button class="input-icon-btn" id="btn-circle" onclick="MGV.startCircle()" style="font-size:20px">‚äô</button>
                                <button class="send-btn" id="send-btn" style="display:none" onclick="MGV.sendMsg()">‚û§</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        <!-- /desk-layout -->
    </div>
    <!-- /app -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="create-channel-modal">
        <div class="modal">
            <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</div>
            <div class="form-group">
                <label class="lbl">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input class="inp" id="new-ch-name" type="text" placeholder="–∫–∞–Ω–∞–ª" maxlength="30">
            </div>
            <div class="form-group">
                <label class="lbl">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input class="inp" id="new-ch-desc" type="text" placeholder="–û —á—ë–º" maxlength="100">
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost btn-sm" onclick="MGV.closeCreateChannel()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-sm" onclick="MGV.submitCreateChannel()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê CIRCLE RECORDER ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="circle-recorder">
        <div class="cr-label">
            <div class="rec-dot"></div><span>–ó–∞–ø–∏—Å—å –∫—Ä—É–∂–∫–∞</span></div>
        <div class="cr-wrap">
            <svg class="cr-svg" viewBox="0 0 284 284">
      <circle class="cr-bg" cx="142" cy="142" r="120"/>
      <circle id="cr-prog" cx="142" cy="142" r="120"/>
    </svg>
            <div class="cr-clip"><video id="cr-vid" autoplay muted playsinline></video></div>
        </div>
        <div class="cr-time" id="cr-time">0:00</div>
        <div class="cr-btns">
            <button class="cr-btn cr-cancel" onclick="MGV.cancelCircle()">‚úï</button>
            <button class="cr-btn cr-ok" onclick="MGV.stopCircle()">‚úì</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê CALL ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="call-overlay">
        <video id="remote-vid" autoplay playsinline></video>
        <div id="call-bg">
            <div class="ca-ring">
                <div id="call-av">?</div>
            </div>
            <div id="call-name">‚Äî</div>
            <div id="call-st">–ó–í–û–ù–ò–ú...</div>
            <div id="call-tmr"></div>
        </div>
        <div id="call-topbar">
            <div id="call-tb-name">‚Äî</div>
            <div id="call-tb-tmr"></div>
        </div>
        <div id="call-pip"><video autoplay muted playsinline id="call-pip-vid"></video></div>
        <div class="call-btns">
            <button class="cbtn cbtn-mic" id="cbtn-mic" onclick="MGV.toggleMute()">üé§</button>
            <button class="cbtn cbtn-cam" id="cbtn-cam" onclick="MGV.toggleVideo()">üìπ</button>
            <button class="cbtn cbtn-end" onclick="MGV.endCall()">üìµ</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê INCOMING ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="incoming">
        <div id="inc-label">üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</div>
        <div id="inc-name">‚Äî</div>
        <div class="inc-btns">
            <button class="btn btn-danger btn-sm" onclick="MGV.declineCall()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            <button class="btn btn-green btn-sm" onclick="MGV.answerCall(false)">üìû –ê—É–¥–∏–æ</button>
            <button class="btn btn-sm" id="ans-vid-btn" onclick="MGV.answerCall(true)" style="display:none">üìπ –í–∏–¥–µ–æ</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê LIGHTBOX ‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="lbox" onclick="this.classList.remove('active')"><img id="lbox-img" src="" alt=""></div>

    <input type="file" id="file-input" style="display:none" accept="*/*">
    <audio id="remote-audio" autoplay playsinline></audio>
    <script src="/app.js"></script>
</body>

</html>